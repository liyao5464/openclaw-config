<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°é‡Œçš„åƒç´ åŠå…¬å®¤</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a0f;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }
        #game-container {
            image-rendering: pixelated;
            border-radius: 4px;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        #status-text {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #ffd700;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            background: rgba(30, 20, 10, 0.9);
            padding: 8px 20px;
            border-radius: 3px;
            max-width: 92%;
            text-align: center;
            border: 2px solid #8B5E3C;
            letter-spacing: 1px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <div id="status-text">åŠ è½½ä¸­...</div>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
    <script>
    const W = 800, H = 600;

    const STATES = {
        idle:        { name: 'å¾…å‘½',     area: 'lounge' },
        writing:     { name: 'å†™ä½œä¸­',   area: 'office' },
        researching: { name: 'æŸ¥èµ„æ–™',   area: 'office' },
        executing:   { name: 'æ‰§è¡Œä»»åŠ¡', area: 'kitchen' },
        syncing:     { name: 'åŒæ­¥å¤‡ä»½', area: 'bedroom' },
        error:       { name: 'å‡ºé”™äº†',   area: 'lounge' }
    };

    const BUBBLE_TEXTS = {
        idle:        ['æ‘¸é±¼ä¸­â€¦', 'å’–å•¡çœŸå¥½å–â˜•', 'ä¼¸ä¸ªæ‡’è…°~', 'ç­‰è€é‡ŒæŒ‡ç¤º', 'å¥½æ— èŠå•Š', 'çœ‹ä¼šä¹¦ğŸ“–'],
        writing:     ['çµæ„Ÿæ¥äº†ï¼', 'å†™å¾—æ‰‹é…¸', 'è¿™æ®µä¸é”™ğŸ‘', 'ç å­—ä¸­...', 'å†æ”¹ä¸€é'],
        researching: ['è®©æˆ‘æœä¸€ä¸‹', 'æ‰¾åˆ°çº¿ç´¢äº†ğŸ”', 'è¿™ä¸ªæœ‰æ„æ€', 'å†æ·±æŒ–ä¸€ç‚¹'],
        executing:   ['å†²é¸­ï¼ğŸ¦†', 'è¿™ä¸ªç®€å•', 'é©¬ä¸Šæå®šğŸ’ª', 'å…¨åŠ›è¾“å‡ºï¼', 'æ³¡æ¯å’–å•¡å…ˆ'],
        syncing:     ['å¤‡ä»½å¤‡ä»½', 'å®‰å…¨ç¬¬ä¸€ğŸ”’', 'åŒæ­¥ä¸­â€¦', 'æ•°æ®å½’æ¡£', 'ç¡ä¸€ä¼šâ€¦ğŸ’¤'],
        error:       ['å•Šå“¦â€¦ğŸ’¥', 'å‡ºbugäº†', 'è®©æˆ‘çœ‹çœ‹', 'é©¬ä¸Šä¿®å¥½ğŸ”§']
    };

    let game, character, shadow, areas = {}, currentState = 'idle';
    let statusText, lastFetch = 0, lastBlink = 0, lastBubble = 0;
    let targetX, targetY, bubble = null;
    let typewriterText = '', typewriterTarget = '', typewriterIndex = 0, lastTypewriter = 0;
    let clawTween = null;

    function preload() {
        this.load.image('office_bg', '/static/office_bg.jpg');

        // äººå½¢é¾™è™¾è§’è‰² - ççœ¼
        const cOpen = this.make.graphics({ add: false });
        drawLobster(cOpen, true);
        cOpen.generateTexture('char_open', 48, 56);

        // äººå½¢é¾™è™¾è§’è‰² - é—­çœ¼
        const cClosed = this.make.graphics({ add: false });
        drawLobster(cClosed, false);
        cClosed.generateTexture('char_closed', 48, 56);
    }

    function drawLobster(g, eyesOpen) {
        const cx = 24; // ä¸­å¿ƒx

        // === å°¾å·´æ‰‡ï¼ˆçº¢è‰²ï¼‰ ===
        g.fillStyle(0xCC2936);
        g.fillRoundedRect(cx - 10, 48, 20, 6, 2);

        // === èµ°è·¯è…¿ï¼ˆçº¢è‰²ï¼‰ ===
        g.lineStyle(2, 0xCC2936);
        g.lineBetween(cx - 6, 40, cx - 12, 48);
        g.lineBetween(cx - 4, 42, cx - 10, 50);
        g.lineBetween(cx + 6, 40, cx + 12, 48);
        g.lineBetween(cx + 4, 42, cx + 10, 50);

        // === ä¸»èº«ä½“ï¼ˆçº¢è‰²ç”²å£³ï¼‰ ===
        g.fillStyle(0xCC2936);
        g.fillRoundedRect(cx - 9, 16, 18, 28, 5);

        // === è…¹éƒ¨ï¼ˆæµ…çº¢ï¼‰ ===
        g.fillStyle(0xE85D7A);
        g.fillRoundedRect(cx - 5, 20, 10, 18, 3);

        // === é’³å­æ‰‹è‡‚ï¼ˆçº¢è‰²è¿æ¥æ®µï¼‰ ===
        g.fillStyle(0xCC2936);
        g.fillRect(cx - 16, 18, 8, 5);
        g.fillRect(cx + 8, 18, 8, 5);

        // === å¤§é’³å­ï¼ˆçº¢è‰²ï¼‰ ===
        // å·¦é’³
        g.fillStyle(0xCC2936);
        g.fillCircle(cx - 18, 16, 7);
        g.fillStyle(0xFF4444);
        g.fillCircle(cx - 18, 14, 4);
        // é’³å£
        g.fillStyle(0x991111);
        g.fillTriangle(cx - 22, 12, cx - 14, 12, cx - 18, 9);

        // å³é’³
        g.fillStyle(0xCC2936);
        g.fillCircle(cx + 18, 16, 7);
        g.fillStyle(0xFF4444);
        g.fillCircle(cx + 18, 14, 4);
        g.fillStyle(0x991111);
        g.fillTriangle(cx + 14, 12, cx + 22, 12, cx + 18, 9);

        // é’³å­é«˜å…‰
        g.fillStyle(0xFFFFFF, 0.5);
        g.fillCircle(cx - 19, 13, 2);
        g.fillCircle(cx + 17, 13, 2);

        // === å¤´éƒ¨ï¼ˆçº¢è‰²ï¼‰ ===
        g.fillStyle(0xCC2936);
        g.fillRoundedRect(cx - 8, 4, 16, 14, 5);

        // === çœ¼ç›ï¼ˆçªå‡ºçš„çœ¼æŸ„ï¼‰ ===
        // çœ¼æŸ„
        g.fillStyle(0xCC2936);
        g.fillRect(cx - 7, 4, 3, 4);
        g.fillRect(cx + 4, 4, 3, 4);

        if (eyesOpen) {
            g.fillStyle(0xFFFFFF);
            g.fillCircle(cx - 6, 3, 4);
            g.fillCircle(cx + 6, 3, 4);
            g.fillStyle(0x000000);
            g.fillCircle(cx - 5, 3, 2);
            g.fillCircle(cx + 5, 3, 2);
            // é«˜å…‰
            g.fillStyle(0xFFFFFF);
            g.fillRect(cx - 6, 2, 1, 1);
            g.fillRect(cx + 5, 2, 1, 1);
        } else {
            g.fillStyle(0xFFFFFF);
            g.fillCircle(cx - 6, 3, 4);
            g.fillCircle(cx + 6, 3, 4);
            g.lineStyle(2, 0x000000);
            g.lineBetween(cx - 8, 3, cx - 3, 3);
            g.lineBetween(cx + 3, 3, cx + 8, 3);
        }

        // === çš‡å† ï¼ˆé‡‘è‰²ï¼‰ ===
        g.fillStyle(0xFFD700);
        g.fillRect(cx - 5, -2, 10, 4);
        // ä¸‰ä¸ªå°–
        g.fillTriangle(cx - 5, -2, cx - 3, -2, cx - 4, -6);
        g.fillTriangle(cx - 1, -2, cx + 1, -2, cx, -8);
        g.fillTriangle(cx + 3, -2, cx + 5, -2, cx + 4, -6);
        // å®çŸ³
        g.fillStyle(0xFF0000);
        g.fillCircle(cx, -1, 1);

        // === å˜´å·´ ===
        g.fillStyle(0xFF6B6B);
        g.fillRect(cx - 2, 14, 4, 2);
    }

    function create() {
        game = this;

        // èƒŒæ™¯å›¾ï¼ˆç¼©æ”¾åˆ°800x600ï¼‰
        const bg = this.add.image(W / 2, H / 2, 'office_bg');
        bg.setDisplaySize(W, H);

        // åŒºåŸŸåæ ‡ï¼ˆåŸºäºç­‰è·åƒç´ é£èƒŒæ™¯ï¼‰
        areas = {
            office:  { x: 250, y: 250 },   // å·¦ä¾§åŠå…¬æ¡ŒåŒºåŸŸ
            lounge:  { x: 350, y: 380 },   // ä¸­é—´æ‰¶æ‰‹æ¤…/é˜…è¯»åŒº
            kitchen: { x: 500, y: 200 },   // å³ä¸Šæ²™å‘åŒº
            bedroom: { x: 550, y: 350 }    // å³ä¾§åºŠé“ºåŒºåŸŸ
        };

        // è§’è‰²é˜´å½±
        shadow = game.add.ellipse(areas.lounge.x, areas.lounge.y + 12, 16, 6, 0x000000, 0.2);
        shadow.setDepth(49);

        // è§’è‰²
        character = game.physics.add.sprite(areas.lounge.x, areas.lounge.y, 'char_open');
        character.setOrigin(0.5);
        character.setScale(2.7);
        character.setDepth(50);

        targetX = areas.lounge.x;
        targetY = areas.lounge.y;

        // åº•éƒ¨ç‰ŒåŒ¾
        const bannerY = H - 28;
        const bannerBg = game.add.rectangle(W / 2, bannerY, 340, 36, 0x3E2215, 0.92);
        bannerBg.setStrokeStyle(2, 0xD4AF37);
        bannerBg.setDepth(90);
        // å†…è¾¹æ¡†
        const bannerInner = game.add.rectangle(W / 2, bannerY, 330, 28, 0x000000, 0);
        bannerInner.setStrokeStyle(1, 0x8B6914, 0.5);
        bannerInner.setDepth(90);

        game.add.text(W / 2, bannerY, 'â­  å°é‡Œçš„åƒç´ åŠå…¬å®¤  â­', {
            fontFamily: '"Press Start 2P", monospace',
            fontSize: '11px',
            color: '#ffd700',
            stroke: '#000',
            strokeThickness: 2
        }).setOrigin(0.5).setDepth(91);

        // ä¸¤ä¾§æ˜Ÿæ˜Ÿè£…é¥°
        game.add.text(W / 2 - 160, bannerY, 'â­', { fontSize: '14px' }).setOrigin(0.5).setDepth(91);
        game.add.text(W / 2 + 160, bannerY, 'â­', { fontSize: '14px' }).setOrigin(0.5).setDepth(91);

        statusText = document.getElementById('status-text');
        fetchStatus();

        // é’³å­æ‘†åŠ¨åŠ¨ç”»
        startIdleAnimation();
    }

    function startIdleAnimation() {
        // å‘¼å¸æ•ˆæœ
        clawTween = game.tweens.add({
            targets: character,
            scaleY: { from: 2.7, to: 2.75 },
            duration: 1200,
            yoyo: true,
            repeat: -1,
            ease: 'Sine.easeInOut'
        });
        // å·¦å³æ‘‡æ™ƒ
        game.tweens.add({
            targets: character,
            angle: { from: -5, to: 5 },
            duration: 2000,
            yoyo: true,
            repeat: -1,
            ease: 'Sine.easeInOut'
        });
    }

    function update(time) {
        if (time - lastFetch > 2500) { fetchStatus(); lastFetch = time; }

        // çœ¨çœ¼
        if (time - lastBlink > 3000 + Math.random() * 2000) {
            character.setTexture('char_closed');
            lastBlink = time;
            game.time.delayedCall(150, () => { if (character) character.setTexture('char_open'); });
        }

        // å†’æ°”æ³¡
        if (time - lastBubble > 6000 + Math.random() * 4000) {
            showBubble();
            lastBubble = time;
        }

        // æ‰“å­—æœºæ•ˆæœ
        if (typewriterIndex < typewriterTarget.length && time - lastTypewriter > 50) {
            typewriterText += typewriterTarget[typewriterIndex];
            statusText.textContent = typewriterText;
            typewriterIndex++;
            lastTypewriter = time;
        }

        moveCharacter(time);

        // åŒæ­¥é˜´å½±ä½ç½®
        shadow.setPosition(character.x, character.y + 12);
    }

    function normalizeState(s) {
        if (!s) return 'idle';
        const map = { working: 'writing', run: 'executing', running: 'executing', sync: 'syncing', research: 'researching' };
        return map[s] || (STATES[s] ? s : 'idle');
    }

    function fetchStatus() {
        fetch('/status').then(r => r.json()).then(data => {
            const next = normalizeState(data.state);
            const info = STATES[next];
            const changed = next !== currentState;
            currentState = next;
            const line = `[${info.name}] ${data.detail || '...'}`;
            if (changed || typewriterTarget !== line) {
                typewriterTarget = line;
                typewriterText = '';
                typewriterIndex = 0;
                if (changed) {
                    const t = areas[info.area];
                    targetX = t.x + (Math.random() - 0.5) * 30;
                    targetY = t.y + (Math.random() - 0.5) * 20;
                }
            }
        }).catch(() => {
            typewriterTarget = 'è¿æ¥å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•...';
            typewriterText = '';
            typewriterIndex = 0;
        });
    }

    function moveCharacter(time) {
        const info = STATES[currentState] || STATES.idle;
        const base = areas[info.area] || areas.lounge;

        // éšæœºè¸±æ­¥ï¼ˆæ›´é¢‘ç¹ï¼‰
        if (Math.random() < 0.01) {
            targetX = base.x + (Math.random() - 0.5) * 80;
            targetY = base.y + (Math.random() - 0.5) * 60;
        }

        const dx = targetX - character.x;
        const dy = targetY - character.y;
        const speed = 2.0;

        if (Math.abs(dx) > 2) character.x += Math.sign(dx) * speed;
        if (Math.abs(dy) > 2) character.y += Math.sign(dy) * speed;

        // èµ°è·¯æ—¶ä¸Šä¸‹é¢ 
        if (Math.abs(dx) > 2 || Math.abs(dy) > 2) {
            character.y += Math.sin(time / 150) * 0.5;
        }

        // Y-sorting depth
        character.setDepth(50 + character.y * 0.01);

        // æ°”æ³¡è·Ÿéšè§’è‰²
        if (bubble) {
            bubble.setPosition(character.x, character.y - 48);
        }
    }

    function showBubble() {
        if (bubble) { bubble.destroy(); bubble = null; }
        const texts = BUBBLE_TEXTS[currentState] || BUBBLE_TEXTS.idle;
        const text = texts[Math.floor(Math.random() * texts.length)];
        const pw = Math.max(text.length * 11 + 20, 80);

        // æ°”æ³¡èƒŒæ™¯
        const bg = game.add.rectangle(character.x, character.y - 48, pw, 26, 0xFFF8DC, 0.92);
        bg.setStrokeStyle(2, 0x8B5E3C);
        bg.setDepth(200);

        // å°ä¸‰è§’
        const tri = game.add.triangle(character.x, character.y - 34, 0, 0, 12, 0, 6, 8, 0xFFF8DC, 0.92);
        tri.setDepth(200);

        // æ–‡å­—
        const txt = game.add.text(character.x, character.y - 48, text, {
            font: '12px monospace',
            fill: '#333',
            align: 'center'
        }).setOrigin(0.5).setDepth(201);

        bubble = game.add.container(0, 0, [bg, tri, txt]);

        // æ·¡å…¥
        bubble.setAlpha(0);
        game.tweens.add({ targets: bubble, alpha: 1, duration: 200 });

        // 3.5ç§’åæ·¡å‡º
        game.time.delayedCall(3500, () => {
            if (bubble) {
                game.tweens.add({
                    targets: bubble, alpha: 0, duration: 300,
                    onComplete: () => { if (bubble) { bubble.destroy(); bubble = null; } }
                });
            }
        });
    }

    new Phaser.Game({
        type: Phaser.AUTO,
        width: W,
        height: H,
        parent: 'game-container',
        pixelArt: true,
        physics: { default: 'arcade', arcade: { gravity: { y: 0 }, debug: false } },
        scene: { preload, create, update }
    });
    </script>
</body>
</html>
