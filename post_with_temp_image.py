#!/usr/bin/env python3
"""
æ£€æŸ¥ draft/add æ¥å£éœ€è¦çš„æ­£ç¡®æ ¼å¼
æ ¹æ®å¾®ä¿¡æ–‡æ¡£ï¼šhttps://developers.weixin.qq.com/doc/offiaccount/Draft_Box/Add_draft.html
"""
import requests

APPID = "wxbde0f982acfe271b"
SECRET = "a561d22a1227a810d66f13efa19bedb1"

# è·å– token
token_url = f"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={APPID}&secret={SECRET}"
token = requests.get(token_url, timeout=30).json().get('access_token')
print(f"âœ… Token: {token[:30]}...")

# å…ˆä¸Šä¼ ä¸€ä¸ªä¸´æ—¶å›¾ç‰‡ä½œä¸ºå°é¢
print("\nğŸ“¤ ä¸Šä¼ ä¸´æ—¶å›¾ç‰‡...")
upload_url = f"https://api.weixin.qq.com/cgi-bin/media/upload?access_token={token}&type=image"

# åˆ›å»ºä¸€ä¸ªç®€å•çš„ 1x1 åƒç´  JPEG
jpeg_data = bytes([
    0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46, 0x49, 0x46, 0x00, 0x01,
    0x01, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0xFF, 0xDB, 0x00, 0x43,
    0x00, 0x08, 0x06, 0x06, 0x07, 0x06, 0x05, 0x08, 0x07, 0x07, 0x07, 0x09,
    0x09, 0x08, 0x0A, 0x0C, 0x14, 0x0D, 0x0C, 0x0B, 0x0B, 0x0C, 0x19, 0x12,
    0x13, 0x0F, 0x14, 0x1D, 0x1A, 0x1F, 0x1E, 0x1D, 0x1A, 0x1C, 0x1C, 0x20,
    0x24, 0x2E, 0x27, 0x20, 0x22, 0x2C, 0x23, 0x1C, 0x1C, 0x28, 0x37, 0x29,
    0x2C, 0x30, 0x31, 0x34, 0x34, 0x34, 0x1F, 0x27, 0x39, 0x3D, 0x38, 0x32,
    0x3C, 0x2E, 0x33, 0x34, 0x32, 0xFF, 0xC0, 0x00, 0x0B, 0x08, 0x00, 0x01,
    0x00, 0x01, 0x01, 0x01, 0x11, 0x00, 0xFF, 0xC4, 0x00, 0x1F, 0x00, 0x00,
    0x01, 0x05, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
    0x09, 0x0A, 0x0B, 0xFF, 0xDA, 0x00, 0x08, 0x01, 0x01, 0x00, 0x00, 0x3F,
    0x00, 0x7F, 0xFF, 0xD9
])

import io
files = {'media': ('test.jpg', io.BytesIO(jpeg_data), 'image/jpeg')}
upload_resp = requests.post(upload_url, files=files, timeout=30).json()
print(f"ä¸Šä¼ ç»“æœ: {upload_resp}")

if 'media_id' in upload_resp:
    media_id = upload_resp['media_id']
    print(f"âœ… ä¸´æ—¶å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: {media_id}")
    
    # ä½¿ç”¨è¿™ä¸ª media_id åˆ›å»ºè‰ç¨¿
    print("\nğŸ“ åˆ›å»ºè‰ç¨¿...")
    draft_url = f"https://api.weixin.qq.com/cgi-bin/draft/add?access_token={token}"
    
    data = {
        "articles": [{
            "title": "çœ‹å®Œæ˜¥æ™šï¼Œæˆ‘å‘ç°è‡ªå·±è¢«æ—¶ä»£ç”©äº†ä¸€æˆª",
            "content": "<p>æµ‹è¯•å†…å®¹</p>",
            "thumb_media_id": media_id
        }]
    }
    
    draft_resp = requests.post(draft_url, json=data, timeout=30).json()
    print(f"è‰ç¨¿ç»“æœ: {draft_resp}")
else:
    print("âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥")
